rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // [GOVERNANCE] Helper: Ensure the entity is Malaysian
    function isMalaysianEntity(entityId) {
      return get(/databases/$(database)/documents/entities/$(entityId)).data.country == 'MY';
    }

    // [TAB 1] Entity Profile Rules
    match /entities/{entityId} {
      // Create: Only if country is explicitly 'MY'
      allow create: if request.auth != null && request.resource.data.country == 'MY';
      
      // Read/Update: Standard auth + country check
      allow read, update: if request.auth != null && resource.data.country == 'MY';

      // [TAB 3] Ledger Entries (Subcollection)
      match /ledgerEntries/{entry} {
        // Prevent updates if entry is LOCKED or AUDIT_READY
        allow update: if isMalaysianEntity(entityId) && 
                     resource.data.status != 'LOCKED' && 
                     resource.data.status != 'AUDIT_READY';
        
        allow read, create: if isMalaysianEntity(entityId);
      }
    }
    
    // [TAB 4] Tax Computations
    match /taxComputations/{taxId} {
      allow read, write: if request.auth != null && 
                          get(/databases/$(database)/documents/entities/$(resource.data.entityId)).data.country == 'MY';
    }
  }
}